name: Build and Test

on:
  push:
    branches: [master]
    paths:
      - 'src/**'
      - 'tests/**'
      - 'app.json'
      - '.github/workflows/build.yml'
  pull_request:
    branches: [master]
    paths:
      - 'src/**'
      - 'tests/**'
      - 'app.json'
      - '.github/workflows/build.yml'
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install BcContainerHelper
        shell: pwsh
        run: |
          Install-Module BcContainerHelper -Force -AllowClobber
          Import-Module BcContainerHelper

      - name: Run AL Pipeline
        shell: pwsh
        run: |
          # Create output directories
          New-Item -ItemType Directory -Force -Path "$env:GITHUB_WORKSPACE/.output" | Out-Null
          New-Item -ItemType Directory -Force -Path "$env:GITHUB_WORKSPACE/.packages" | Out-Null

          # Run the AL pipeline - this handles container creation, compilation, and testing
          $params = @{
            pipelineName = "BusinessCentral.AL.Mutations"
            appFolders = @($env:GITHUB_WORKSPACE)
            testFolders = @("$env:GITHUB_WORKSPACE/tests")
            appOutputFolder = "$env:GITHUB_WORKSPACE/.output"
            containerName = "bcmutations"
            credential = (New-Object PSCredential 'admin', (ConvertTo-SecureString 'P@ssw0rd' -AsPlainText -Force))
            memoryLimit = "8G"
            doNotRunTests = $false
            enableCodeCop = $false
            enableAppSourceCop = $false
            enablePerTenantExtensionCop = $false
            enableUICop = $false
            useDevEndpoint = $false
            reuseContainer = $false
            installTestFramework = $true
            installTestLibraries = $true
            installPerformanceToolkit = $false
          }

          Run-AlPipeline @params

      - name: Upload Build Artifacts
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: app-package
          path: .output/*.app
          if-no-files-found: ignore
