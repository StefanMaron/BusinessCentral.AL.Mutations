name: Claude Developer Agent

on:
  issues:
    types: [opened, edited, labeled]
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]
  schedule:
    # Run autonomous check every 6 hours
    - cron: '0 */6 * * *'
  workflow_dispatch:
    inputs:
      task:
        description: 'Specific instruction for Claude'
        required: false
        type: string

# Only allow one Claude agent to run at a time
concurrency:
  group: claude-agent
  cancel-in-progress: false

jobs:
  # Filter job to determine if we should run
  should-run:
    runs-on: ubuntu-latest
    outputs:
      run: ${{ steps.check.outputs.run }}
    steps:
      - id: check
        run: |
          # Always run on workflow_dispatch or schedule
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]] || [[ "${{ github.event_name }}" == "schedule" ]]; then
            echo "run=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          # For issues/comments, check if it's from a human (not the bot)
          ACTOR="${{ github.actor }}"
          if [[ "$ACTOR" == "github-actions[bot]" ]] || [[ "$ACTOR" == "claude-dev[bot]" ]]; then
            echo "run=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Check for @claude mention or /claude command in comments
          COMMENT_BODY="${{ github.event.comment.body }}"
          ISSUE_BODY="${{ github.event.issue.body }}"

          if [[ "$COMMENT_BODY" == *"@claude"* ]] || [[ "$COMMENT_BODY" == "/claude"* ]] || \
             [[ "$ISSUE_BODY" == *"@claude"* ]] || [[ "${{ github.event_name }}" == "issues" ]]; then
            echo "run=true" >> $GITHUB_OUTPUT
          else
            echo "run=false" >> $GITHUB_OUTPUT
          fi

  claude-agent:
    needs: should-run
    if: needs.should-run.outputs.run == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Claude Code
        run: npm install -g @anthropic-ai/claude-code

      - name: Configure Git
        run: |
          git config user.name "Claude Developer"
          git config user.email "claude-dev@users.noreply.github.com"

      - name: Prepare context
        id: context
        run: |
          # Build context based on trigger
          echo "EVENT_NAME=${{ github.event_name }}" >> $GITHUB_ENV

          if [[ "${{ github.event_name }}" == "issues" ]]; then
            echo "ISSUE_NUMBER=${{ github.event.issue.number }}" >> $GITHUB_ENV
            echo "ISSUE_TITLE=${{ github.event.issue.title }}" >> $GITHUB_ENV
            # Write issue body to file to handle special characters
            cat << 'ISSUE_BODY_EOF' > /tmp/issue_body.txt
          ${{ github.event.issue.body }}
          ISSUE_BODY_EOF
          fi

          if [[ "${{ github.event_name }}" == "issue_comment" ]]; then
            echo "ISSUE_NUMBER=${{ github.event.issue.number }}" >> $GITHUB_ENV
            echo "ISSUE_TITLE=${{ github.event.issue.title }}" >> $GITHUB_ENV
            cat << 'COMMENT_BODY_EOF' > /tmp/comment_body.txt
          ${{ github.event.comment.body }}
          COMMENT_BODY_EOF
          fi

          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "MANUAL_TASK=${{ github.event.inputs.task }}" >> $GITHUB_ENV
          fi

      - name: Run Claude Agent
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Build the prompt from template
          PROMPT=$(cat .github/prompts/agent-prompt.md)

          # Add context based on trigger
          if [[ -f /tmp/issue_body.txt ]]; then
            ISSUE_BODY=$(cat /tmp/issue_body.txt)
            PROMPT="$PROMPT

          ## Current Issue #$ISSUE_NUMBER: $ISSUE_TITLE

          $ISSUE_BODY"
          fi

          if [[ -f /tmp/comment_body.txt ]]; then
            COMMENT_BODY=$(cat /tmp/comment_body.txt)
            PROMPT="$PROMPT

          ## New Comment on Issue #$ISSUE_NUMBER

          $COMMENT_BODY"
          fi

          if [[ -n "$MANUAL_TASK" ]]; then
            PROMPT="$PROMPT

          ## Manual Task

          $MANUAL_TASK"
          fi

          if [[ "$EVENT_NAME" == "schedule" ]]; then
            PROMPT="$PROMPT

          ## Scheduled Maintenance Run

          Check for:
          1. Open issues that need attention
          2. Stale PRs that need updates
          3. Failing tests to fix
          4. Documentation improvements"
          fi

          # Run Claude with the prompt
          claude --dangerously-skip-permissions -p "$PROMPT"

      - name: Push changes if any
        run: |
          if [[ -n $(git status --porcelain) ]]; then
            git add -A
            git status
            # Changes will be committed by Claude during its run
            # This is just a safety push in case anything was missed
            git push || true
          fi
