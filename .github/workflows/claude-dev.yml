name: Claude Developer Agent

on:
  issues:
    types: [opened, edited]
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]
  pull_request_review:
    types: [submitted]
  pull_request:
    types: [opened, synchronize]
  workflow_dispatch:
    inputs:
      task:
        description: 'Specific instruction for Claude'
        required: false
        type: string

# Only allow one Claude agent to run at a time
concurrency:
  group: claude-agent-${{ github.event.issue.number || github.event.pull_request.number || github.run_id }}
  cancel-in-progress: false

jobs:
  claude-agent:
    # Skip if comment is from a bot
    if: |
      (github.event_name == 'workflow_dispatch') ||
      (github.event_name == 'issues') ||
      (github.event_name == 'pull_request') ||
      (github.event_name == 'pull_request_review' && github.event.review.state == 'changes_requested') ||
      (github.event_name == 'issue_comment' && !github.event.issue.pull_request && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'issue_comment' && github.event.issue.pull_request && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'pull_request_review_comment' && contains(github.event.comment.body, '@claude'))

    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
      pull-requests: write
      id-token: write  # Required for OIDC authentication

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run Claude Code Action
        uses: anthropics/claude-code-action@beta
        env:
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
        with:
          # Use the agent prompt as system instructions
          system_prompt: |
            You are an autonomous AL developer working on BusinessCentral.AL.Mutations.

            Read CONCEPT.md for the product vision and CLAUDE.md for development guidelines.

            Your workflow:
            1. Analyze the issue or PR context
            2. If it's a new issue: comment your plan, create branch, implement with TDD, create PR
            3. If it's a comment: respond helpfully or implement requested changes
            4. If it's a PR review: address feedback and push updates

            AL Code Standards:
            - Prefix all objects with "SMC" (Stefan Maron Consulting)
            - Use XML documentation on public procedures
            - Write tests first (TDD)
            - Follow fluent interface pattern

            Available commands in comments:
            - @claude implement - Start working on this issue
            - @claude status - Report progress
            - @claude help - Explain options

          # Custom instructions for this run
          custom_instructions: |
            Focus on the triggered event. Be autonomous but communicate your plans.
            Create small, focused commits. Always run tests before creating PRs.

          # Allow Claude to use these tools
          allowed_tools: |
            Bash
            Read
            Write
            Edit
            Glob
            Grep

          # Direct Claude to push changes
          push_changes: true

          # Create PRs automatically
          create_pull_request: true
